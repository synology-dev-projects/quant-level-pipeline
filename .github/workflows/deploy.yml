name: Branch-Based Deployment Pipeline

# 1. RUN ON ALL BRANCHES
on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-branch:
    runs-on: self-hosted

    steps:
      # --- [NEW] STEP 1: FORCE CLEAN RUNNER WORKSPACE ---
      - name: Clean Runner Workspace
        run: |
          echo "ðŸ§¹ Cleaning previous runner artifacts..."
          # This deletes everything in the current runner folder before checkout
          rm -rf ./*
          rm -rf ./.??*

      # --- SETUP ---
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Load Synology Paths
        run: |
          cat ../../conf/syno_paths.env >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          # 1. Check if .venv exists
          if [ ! -d ".venv" ]; then
            echo "Creating virtual environment..."
            python3 -m venv .venv
          else
            echo "Virtual environment found."
          fi
          
          # 2. Activate venv
          source .venv/bin/activate
          pip install --upgrade pip
          
          # 3. AUTO-UPDATE DEPENDENCIES
          pip install pip-tools
          
          if [ -f "requirements.in" ]; then
            echo "ðŸ”„ Compiling requirements.in..."
            pip-compile requirements.in --output-file=requirements.txt
          else
            echo "âš ï¸ No requirements.in found, skipping auto-compile."
          fi
          
          pip install -r requirements.txt
          
          # 5. Add venv to GITHUB_PATH for subsequent steps
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      # --- [UPDATED] DYNAMIC DEPLOYMENT ---
      - name: Deploy to Branch Folder
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          REPO_NAME="${{ github.event.repository.name }}"
          TARGET_PATH="${{ env.SYNOLOGY_ROOT_PATH }}/${BRANCH_NAME}/${REPO_NAME}"
          
          echo "ðŸ“‚ Branch detected: $BRANCH_NAME"
          echo "ðŸš€ Deploying to: $TARGET_PATH"
          
          # Ensure target directory exists
          mkdir -p "$TARGET_PATH"

          # --- FIX IS HERE: WIPE OLD CODE BEFORE COPYING ---
          # We delete the specific source folders to remove files you deleted in git.
          echo "ðŸ§¹ Wiping old src/ and tests/ in destination..."
          rm -rf "$TARGET_PATH/src"
          rm -rf "$TARGET_PATH/tests"
          rm -f "$TARGET_PATH/verify.sh"

          # Now copy fresh (No -u flag needed, we want exact copy)
          cp -r src/ "$TARGET_PATH/"
          cp -r tests/ "$TARGET_PATH/"
          cp verify.sh "$TARGET_PATH/"
          
          echo "DEPLOY_DIR=$TARGET_PATH" >> $GITHUB_ENV

      # --- SECRET INJECTION ---
      - name: Create Runtime .env File
        run: |
          ENV_FILE="${{ env.DEPLOY_DIR }}/.env"
          
          echo "Generating secure .env file at $ENV_FILE..."
          
          echo "ORACLE_USER=${{ secrets.ORACLE_USER }}" > "$ENV_FILE"
          echo "ORACLE_PASS=${{ secrets.ORACLE_PASS }}" >> "$ENV_FILE"
          echo "ORACLE_HOST_IP=${{ secrets.ORACLE_HOST_IP }}" >> "$ENV_FILE"
          echo "ORACLE_SERVICE=${{ secrets.ORACLE_SERVICE }}" >> "$ENV_FILE"
          echo "TE_COOKIE=${{ secrets.TE_COOKIE }}" >> "$ENV_FILE"
          
          chmod 600 "$ENV_FILE"

      # --- VERIFICATION ---
      - name: Run Verification
        run: |
          echo "ðŸ§ª Testing branch: ${{ github.ref_name }}"
          cd "${{ env.DEPLOY_DIR }}"
          chmod +x verify.sh
          ./verify.sh

      # --- CONDITIONAL MERGE ---
      - name: Auto-Promote to Master
        if: github.ref_name == 'develop'
        run: |
          echo "âœ… Develop verified. Promoting to Master..."
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # FIX: Discard the auto-generated requirements.txt changes 
          # so we can switch branches safely.
          git reset --hard
          
          git fetch origin develop
          git checkout master
          git pull origin master
          
          git merge origin/develop --no-ff -m "Auto-merge develop to master [Skip CI]"
          git push origin master