name: Staging to Production Pipeline

# 1. TRIGGER
on:
  push:
    branches: [ "Develop" ]
  # Allows you to click "Run workflow" manually in the Actions tab for testing
  workflow_dispatch:

# 2. PERMISSIONS
permissions:
  contents: write

jobs:
  deploy-and-promote:
    runs-on: self-hosted

    steps:
      # --- SETUP PHASE ---

      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Required for merging

      - name: Debug Directory (Optional)
        run: |
          echo "ðŸ“ Current location:"
          pwd
          echo "ðŸ”Ž Looking for conf..."
          ls -R ../../

      - name: Load Synology Paths
        run: |
          echo "Loading configuration..."
          
          # UPDATED PATH: We go up 3 levels now 
          # (_work/Repo/Repo -> _work/Repo -> _work -> Root -> conf)
          cat ../../conf/syno_paths.env >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # --- STAGING PHASE ---

      - name: Deploy to Staging Folder
        run: |
          STAGING_PATH="${{ env.SYNOLOGY_ROOT_PATH }}/${{ github.event.repository.name }}/staging"
          echo "Deploying to Staging: $STAGING_PATH"
          
          mkdir -p "$STAGING_PATH"
          cp -ru src/ "$STAGING_PATH/"
          cp verify.sh "$STAGING_PATH/"
          
          echo "STAGING_DIR=$STAGING_PATH" >> $GITHUB_ENV

      - name: Run Verification in Staging
        run: |
          echo "Running tests in Staging..."
          cd "${{ env.STAGING_DIR }}"
          chmod +x verify.sh
          ./verify.sh

      # --- PROMOTION PHASE ---

      - name: Safe Merge to Main
        run: |
          echo "Tests passed. Promoting..."
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git checkout main
          git pull origin main
          
          if git merge develop --no-commit; then
              echo "Merge successful. Committing..."
              git commit -m "Auto-merge develop to main [Skip CI]"
              git push origin main
          else
              echo "::error::MERGE CONFLICT. Aborting."
              git merge --abort
              exit 1
          fi

      # --- PRODUCTION PHASE ---

      - name: Deploy to Production Folder
        run: |
          PROD_PATH="${{ env.SYNOLOGY_ROOT_PATH }}/${{ github.event.repository.name }}/prod"
          echo "Deploying to Production: $PROD_PATH"
          
          mkdir -p "$PROD_PATH"
          cp -ru src/ "$PROD_PATH/"
          
          echo "SUCCESS: Deployed to Production."